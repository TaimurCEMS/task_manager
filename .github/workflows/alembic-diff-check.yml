name: Alembic Diff Check
on:
  push:
    branches: [ main, housekeeping-phase5 ]
  pull_request:
    branches: [ main ]

jobs:
  alembic-diff:
    if: ${{ github.actor != 'github-actions[bot]' }}
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: ${{ github.workspace }}
      DATABASE_URL: sqlite:///./test.db    # we want a simple, local SQLite DB
      LOG_LEVEL: INFO
      LOG_JSON: "false"
      SECRET_KEY: dev
      ACCESS_TOKEN_EXPIRE_MINUTES: "30"
      PIP_DISABLE_PIP_VERSION_CHECK: 1
      PYTHONDONTWRITEBYTECODE: 1

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true
          pip install -r requirements-dev.txt || true
          pip install alembic SQLAlchemy aiosqlite "psycopg2-binary"

      - name: Debug Python imports & env
        run: |
          python - <<'PY'
          import os, sys
          print("sys.version   =", sys.version)
          print("cwd           =", os.getcwd())
          print("PYTHONPATH    =", os.environ.get("PYTHONPATH"))
          print("DATABASE_URL  =", os.environ.get("DATABASE_URL"))
          if os.getcwd() not in sys.path:
              sys.path.insert(0, os.getcwd())
          import app
          print("✅ Imported 'app' OK")
          PY

      - name: Ensure versions dir exists
        run: mkdir -p alembic/versions

      - name: Bootstrap schema (create_all)
        run: |
          python - <<'PY'
          import os, sys
          if os.getcwd() not in sys.path:
              sys.path.insert(0, os.getcwd())
          # create all tables from models so Alembic can add indexes on a fresh DB
          from app.db.base_class import Base
          from app.db.session import engine
          Base.metadata.create_all(bind=engine)
          print("✅ Base.metadata.create_all executed")
          PY

      - name: Upgrade DB (Alembic)
        run: |
          python -m alembic upgrade head

      - name: Count migrations before
        id: before
        run: echo "count_before=$(ls -1 alembic/versions | wc -l)" >> $GITHUB_OUTPUT

      - name: Autogenerate (dry check)
        run: |
          python -m alembic revision --autogenerate -m "ci-autogen-check" || true

      - name: Count migrations after
        id: after
        run: echo "count_after=$(ls -1 alembic/versions | wc -l)" >> $GITHUB_OUTPUT

      - name: Fail if drift detected
        if: ${{ steps.after.outputs.count_after != steps.before.outputs.count_before }}
        run: |
          echo "::error::Schema drift detected. Commit an Alembic migration."
          git ls-files --others --exclude-standard alembic/versions || true
          git --no-pager diff -- alembic/versions || true
          exit 1

      - name: Cleanup generated file (if any)
        if: ${{ steps.after.outputs.count_after != steps.before.outputs.count_before }}
        run: rm -f alembic/versions/*.py
